---
attachments: [Clipboard_2021-05-17-22-12-52.png]
title: LVS 简单配置
created: '2021-05-17T12:34:58.762Z'
modified: '2021-05-17T15:11:07.213Z'
---

# LVS 简单配置

## DR模式配置
DR模式的配置关键点：
> - 局域网VIP隐藏
> - MAC修改转发

### VIP隐藏
> 网卡配置多IP(注意掩码位)：
> 1. ifconfig [网卡名]:[接口号] [IP地址] [netmask] [掩码地址]
> 2. ifconfig [网卡名]:[接口号] [IP地址]/[掩码位]
>
> 移除配置：
> 1. ifconfig [网卡名]:[接口号] down
> 
> LVS的掩码地址为255.255.255.0是为了能正确接收局域网中交换机发送的数据包。
> 其他服务器的掩码要为255.255.255.255是为了避免其eth0网卡与lo网卡的netmask都是255.255.255.0，导致2块网卡识别的网络号都是192.168.180.*，数据包从最近的网卡lo发送，目的是要从eth0网卡出去。

### ARP MAC配置
修改kernel parameter，主要目录`/proc/sys/net/ipv4/conf/[all/ens32/lo/default]`：
`arp_ignore`：定义接收到arp请求时的响应级别。
> - 0：只要本地配置的有相应地址，就给予响应。(默认)
> - 1：仅在请求的目标MAC地址配置请求到达的接口上的时候，才会给予响应。
>
> 访问受限，不能写，直接利用重定向变更值。变更`[eth0/all]`2个网卡配置。

`arp_announce`：定义将自己地址向外通告时的通告级别。
> - 0：将本地任何接口上的任何地址向外通告。(默认)
> - 1：试图仅向目标网络通告与其网络匹配的地址。
> - 2：仅向与本地接口上的地址匹配的网络地址通告。
>
> 访问受限，不能写，直接利用重定向变更值。变更`[eth0/all]`2个网卡配置。

### 演示配置
windows上配置演示：
![配置演示](@attachment/Clipboard_2021-05-17-22-12-52.png)
> 1. yum install -y ipvsadm：安装lvs
> 2. ipvsadm -A -t 192.168.180.233:80 -s rr：配置入口规则t=tcp，rr=轮询负载
> 3. ipvsadm -a -t 192.168.180.233:80 -r 192.168.180.182 -g -w 1：r=重定向，w[数字]=权重
> 4. ipvsadm -a -t 192.168.180.233:80 -r 192.168.180.183 -g -w 1：配置lvs到2台机器的负载映射
> 5. ipvsadm -ln：查看lvs配置路由规则，加参数c=查看路由记录表
>
> 映射的规则配置是为了获取到对应机器的MAC地址，方便LVS修改MAC后转发数据包。

## 小结
1. 啊这，难搞。
> 那就用keepAlived吧，简化LVS的配置，并提供高可用保证。

